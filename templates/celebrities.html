{% extends "base.html" %}

{% block title %}{{ title }} - BeeMD{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/celebrities.css') }}">
<style>
    :root {
        --vurgu-mavi: #3498db;
    }

    .multiselect {
        position: relative;
        display: inline-block;
        min-width: 150px;
        width: 100%;
    }

    .selectBox {
        position: relative;
        cursor: pointer;
    }

    .selectBox select {
        width: 100%;
        font-weight: normal;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #444;
        background-color: #333;
        color: white;
        pointer-events: none;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
    }

    .overSelect {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
    }

    #checkboxes {
        display: none;
        border: 1px solid #444;
        position: absolute;
        top: calc(100% + 5px);
        left: 0;
        background-color: #2a2a2a;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        border-radius: 6px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6);
    }

    #reset-professions-btn {
        width: 100%;
        padding: 10px;
        background-color: #3a3a3a;
        color: #bbb;
        border: none;
        border-bottom: 2px solid #444;
        cursor: pointer;
        text-align: center;
        font-size: 0.9rem;
        font-weight: bold;
        transition: all 0.2s;
    }

    #reset-professions-btn:hover {
        background-color: #444;
        color: white;
    }

    #checkboxes label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        color: #ddd;
        cursor: pointer;
        border-bottom: 1px solid #333;
        font-size: 0.95rem;
        transition: background-color 0.2s;
    }

    #checkboxes label:hover {
        background-color: rgba(52, 152, 219, 0.15);
    }

    #checkboxes input[type="checkbox"] {
        accent-color: var(--vurgu-mavi);
        transform: scale(1.3);
        margin-left: 10px;
        cursor: pointer;
    }

    #checkboxes input:checked+span {
        color: var(--vurgu-mavi);
        font-weight: bold;
    }

    #checkboxes label:has(input:checked) {
        background-color: rgba(52, 152, 219, 0.08);
    }
</style>
{% endblock %}

{% block content %}
<div class="container celebrities-page">

    <h1>{{ title }}</h1>

    <form action="{{ url_for('celebrity.celebrities') }}" method="get">

        <div class="search-box">
            <input type="text" name="q" placeholder="Search celebrities..." value="{{ request.args.get('q', '') }}">
            <button type="submit">Search</button>
        </div>

        <div class="filters">

            <div class="multiselect">
                <div class="selectBox">
                    <select>
                        <option>Select Professions</option>
                    </select>
                    <div class="overSelect"></div>
                </div>
                <div id="checkboxes">
                    <button type="button" id="reset-professions-btn">üîÑ Reset Selections</button>

                    <label>
                        <span>Accountant</span>
                        <input type="checkbox" name="profession" value="accountant" {% if 'accountant' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Actor</span>
                        <input type="checkbox" name="profession" value="actor" {% if 'actor' in selected_professions
                            %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Actress</span>
                        <input type="checkbox" name="profession" value="actress" {% if 'actress' in selected_professions
                            %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Animation Dept.</span>
                        <input type="checkbox" name="profession" value="animation_department" {%
                            if 'animation_department' in selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Archive Footage</span>
                        <input type="checkbox" name="profession" value="archive_footage" {% if 'archive_footage' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Archive Sound</span>
                        <input type="checkbox" name="profession" value="archive_sound" {% if 'archive_sound' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Art Department</span>
                        <input type="checkbox" name="profession" value="art_department" {% if 'art_department' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Art Director</span>
                        <input type="checkbox" name="profession" value="art_director" {% if 'art_director' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Assistant</span>
                        <input type="checkbox" name="profession" value="assistant" {% if 'assistant' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Assistant Director</span>
                        <input type="checkbox" name="profession" value="assistant_director" {% if 'assistant_director'
                            in selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Camera Department</span>
                        <input type="checkbox" name="profession" value="camera_department" {% if 'camera_department' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Casting Department</span>
                        <input type="checkbox" name="profession" value="casting_department" {% if 'casting_department'
                            in selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Casting Director</span>
                        <input type="checkbox" name="profession" value="casting_director" {% if 'casting_director' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Choreographer</span>
                        <input type="checkbox" name="profession" value="choreographer" {% if 'choreographer' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Cinematographer</span>
                        <input type="checkbox" name="profession" value="cinematographer" {% if 'cinematographer' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Composer</span>
                        <input type="checkbox" name="profession" value="composer" {% if 'composer' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Costume Department</span>
                        <input type="checkbox" name="profession" value="costume_department" {% if 'costume_department'
                            in selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Costume Designer</span>
                        <input type="checkbox" name="profession" value="costume_designer" {% if 'costume_designer' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Director</span>
                        <input type="checkbox" name="profession" value="director" {% if 'director' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Editor</span>
                        <input type="checkbox" name="profession" value="editor" {% if 'editor' in selected_professions
                            %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Editorial Department</span>
                        <input type="checkbox" name="profession" value="editorial_department" {%
                            if 'editorial_department' in selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Electrical Department</span>
                        <input type="checkbox" name="profession" value="electrical_department" {%
                            if 'electrical_department' in selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Executive</span>
                        <input type="checkbox" name="profession" value="executive" {% if 'executive' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Legal</span>
                        <input type="checkbox" name="profession" value="legal" {% if 'legal' in selected_professions
                            %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Location Management</span>
                        <input type="checkbox" name="profession" value="location_management" {% if 'location_management'
                            in selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Make Up Department</span>
                        <input type="checkbox" name="profession" value="make_up_department" {% if 'make_up_department'
                            in selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Manager</span>
                        <input type="checkbox" name="profession" value="manager" {% if 'manager' in selected_professions
                            %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Miscellaneous</span>
                        <input type="checkbox" name="profession" value="miscellaneous" {% if 'miscellaneous' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Music Artist</span>
                        <input type="checkbox" name="profession" value="music_artist" {% if 'music_artist' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Music Department</span>
                        <input type="checkbox" name="profession" value="music_department" {% if 'music_department' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Podcaster</span>
                        <input type="checkbox" name="profession" value="podcaster" {% if 'podcaster' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Producer</span>
                        <input type="checkbox" name="profession" value="producer" {% if 'producer' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Production Department</span>
                        <input type="checkbox" name="profession" value="production_department" {%
                            if 'production_department' in selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Production Designer</span>
                        <input type="checkbox" name="profession" value="production_designer" {% if 'production_designer'
                            in selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Production Manager</span>
                        <input type="checkbox" name="profession" value="production_manager" {% if 'production_manager'
                            in selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Publicist</span>
                        <input type="checkbox" name="profession" value="publicist" {% if 'publicist' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Script Department</span>
                        <input type="checkbox" name="profession" value="script_department" {% if 'script_department' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Set Decorator</span>
                        <input type="checkbox" name="profession" value="set_decorator" {% if 'set_decorator' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Sound Department</span>
                        <input type="checkbox" name="profession" value="sound_department" {% if 'sound_department' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Soundtrack</span>
                        <input type="checkbox" name="profession" value="soundtrack" {% if 'soundtrack' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Special Effects</span>
                        <input type="checkbox" name="profession" value="special_effects" {% if 'special_effects' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Stunts</span>
                        <input type="checkbox" name="profession" value="stunts" {% if 'stunts' in selected_professions
                            %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Talent Agent</span>
                        <input type="checkbox" name="profession" value="talent_agent" {% if 'talent_agent' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Transportation Department</span>
                        <input type="checkbox" name="profession" value="transportation_department" {%
                            if 'transportation_department' in selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Visual Effects</span>
                        <input type="checkbox" name="profession" value="visual_effects" {% if 'visual_effects' in
                            selected_professions %}checked{% endif %} />
                    </label>

                    <label>
                        <span>Writer</span>
                        <input type="checkbox" name="profession" value="writer" {% if 'writer' in selected_professions
                            %}checked{% endif %} />
                    </label>
                </div>
            </div>

            <select name="primary_name">
                <option value="">All Names</option>
                {% set letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' %}
                {% for letter in letters %}
                <option value="{{ letter }}" {% if request.args.get('primary_name')==letter %}selected{% endif %}>
                    Starts with {{ letter }}
                </option>
                {% endfor %}
            </select>

            <select name="birth_year">
                <option value="">Birth Year</option>
                {% for year in range(2025, 1799, -1) %}
                <option value="{{ year }}" {% if request.args.get('birth_year')==year|string %}selected{% endif %}>
                    {{ year }}
                </option>
                {% endfor %}
            </select>

            <select name="death_year">
                <option value="">Death Year</option>
                {% for year in range(2025, 1799, -1) %}
                <option value="{{ year }}" {% if request.args.get('death_year')==year|string %}selected{% endif %}>
                    {{ year }}
                </option>
                {% endfor %}
            </select>

            <select name="order_by">
                <option value="">Order By</option>
                <option value="alphabetical" {% if request.args.get('order_by')=='alphabetical' %}selected{% endif %}>
                    Name (A-Z)</option>
                <option value="age-asc" {% if request.args.get('order_by')=='age-asc' %}selected{% endif %}>Age
                    (Youngest First)</option>
                <option value="age-desc" {% if request.args.get('order_by')=='age-desc' %}selected{% endif %}>Age
                    (Oldest First)</option>
            </select>

            <button type="submit" id="filter-btn">Apply Filters</button>
        </div>
    </form>
    </form>

    <hr style="border-color: rgba(255,255,255,0.1); margin: 25px 0;">

    <div class="results-header">
        <h2>Results ({{ items|length if items else 0 }})</h2>
        <button type="button" class="info-btn" id="showSqlBtn" title="Show SQL Query">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
        </button>
    </div>

    <div class="sql-popup-overlay" id="sqlPopup">
        <div class="sql-popup">
            <div class="sql-popup-header">
                <h3>Executed SQL Query</h3>
                <button type="button" class="close-btn" id="closeSqlBtn">&times;</button>
            </div>
            <div class="sql-popup-content">
                <pre><code>{{ sql_query | default('No query executed yet.') }}</code></pre>
            </div>
        </div>
    </div>


    <div class="celebrity-list">
        {% if items %}
        {% for person in items %}
        <div class="celebrity-item-row" style="position: relative; display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #222; border-radius: 8px; margin-bottom: 10px;">
            
            <a href="{{ url_for('celebrity.celebrity_detail', people_id=person.peopleId) }}" style="text-decoration: none; flex: 1;">
                <div class="info-left">
                    <h3 class="name" style="color: #d65a1a; margin: 0; font-weight: bold;">{{ person.primaryName }}</h3>
                    
                    <span class="profession" style="color: #bbb; font-size: 0.9rem;">
                    {% if person.professionName and person.professionName != '0' and person.professionName != 0 %}
                        {{ person.professionName | replace('_', ' ') | replace(',', ', ') | title }}
                    {% endif %}
                    </span>
                </div>
            </a>

            <div class="info-right" style="display: flex; align-items: center; gap: 15px;">
                
                <span class="year" style="color: #d65a1a; font-weight: bold; font-size: 1.1rem;">
                    {% if person.deathYear %}
                        {{ person.birthYear }} - {{ person.deathYear }}
                    {% else %}
                        {{ person.birthYear if person.birthYear else '?' }}
                    {% endif %}
                </span>

                <button class="like-btn {{ 'liked' if person.is_liked else '' }}" 
                        data-id="{{ person.peopleId }}" 
                        data-type="person"
                        onclick="toggleLike(this, event)">
                    ‚ù§
                </button>
            </div>
        </div>
        {% endfor %}
        {% else %}
            <p style="text-align: center; color: #888;">No celebrities found.</p>
        {% endif %}
    </div>

<style>
    .like-btn {
        background: none;
        border: none;
        font-size: 1.8rem;
        cursor: pointer;
        color: #555; /* Varsayƒ±lan gri renk */
        transition: transform 0.2s, color 0.2s;
        z-index: 10;
        padding: 0 10px;
    }
    .like-btn:hover { transform: scale(1.2); }
    
    /* Beƒüenilince Kƒ±rmƒ±zƒ± Olsun */
    .like-btn.liked { color: #e50914; }
</style>

<script>
    function toggleLike(btn, event) {
        event.preventDefault(); 
        event.stopPropagation();

        const peopleId = btn.getAttribute('data-id');
        
        let formData = new FormData();
        formData.append('people_id', peopleId);

        fetch('/like_celebrity', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text()) 
        .then(data => {
            if (data === "1") {
                if (btn.classList.contains('liked')) {
                    btn.classList.remove('liked');
                } else {
                    btn.classList.add('liked');
                }
            } else {
                alert("Login Required to Like.");
            }
        })
        .catch(err => console.error('Hata:', err));
    }
</script>

</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- 1. B√ñL√úM: √áOKLU SE√áƒ∞M (MULTISELECT) MANTIƒûI ---
        let expanded = false;
        const selectBox = document.querySelector('.selectBox');
        const checkboxes = document.getElementById("checkboxes");
        const resetBtn = document.getElementById("reset-professions-btn");

        // Kutucuƒüa tƒ±klanƒ±nca men√ºy√º a√ß/kapat
        if (selectBox) {
            selectBox.addEventListener('click', (e) => {
                e.stopPropagation();
                if (!expanded) {
                    checkboxes.style.display = "block";
                    expanded = true;
                } else {
                    checkboxes.style.display = "none";
                    expanded = false;
                }
            });
        }

        // Men√ºn√ºn i√ßine tƒ±klanƒ±nca kapanmasƒ±n
        if (checkboxes) {
            checkboxes.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }

        // Reset butonuna tƒ±klanƒ±nca se√ßimleri kaldƒ±r
        if (resetBtn) {
            resetBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const inputs = checkboxes.querySelectorAll('input[type="checkbox"]');
                inputs.forEach(input => {
                    input.checked = false;
                });
            });
        }

        // Sayfanƒ±n bo≈ü bir yerine tƒ±klanƒ±rsa men√ºy√º kapat
        document.addEventListener('click', (e) => {
            if (expanded) {
                checkboxes.style.display = "none";
                expanded = false;
            }
        });


        // --- 2. B√ñL√úM: SQL POPUP (EPISODES SAYFASI MANTIƒûI) ---
        const showSqlBtn = document.getElementById('showSqlBtn');
        const sqlPopup = document.getElementById('sqlPopup');
        const closeSqlBtn = document.getElementById('closeSqlBtn');

        if (showSqlBtn && sqlPopup) {
            // ƒ∞kon butonuna basƒ±nca Popup'ƒ± a√ß
            showSqlBtn.addEventListener('click', function () {
                sqlPopup.classList.add('active');
                document.body.style.overflow = 'hidden'; // Arka plan kaymasƒ±nƒ± engelle
            });

            // Kapatma fonksiyonu (Tekrar tekrar yazmamak i√ßin)
            const closePopup = () => {
                sqlPopup.classList.remove('active');
                document.body.style.overflow = ''; // Kaydƒ±rmayƒ± geri a√ß
            };

            // X butonuna basƒ±nca kapat
            if (closeSqlBtn) {
                closeSqlBtn.addEventListener('click', closePopup);
            }

            // Siyah arka plana (Overlay) basƒ±nca kapat
            sqlPopup.addEventListener('click', function (e) {
                if (e.target === sqlPopup) {
                    closePopup();
                }
            });

            // ESC tu≈üuna basƒ±nca kapat
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && sqlPopup.classList.contains('active')) {
                    closePopup();
                }
            });
        }
    });
    window.addEventListener("pageshow", function(event) {
        
        var historyTraversal = event.persisted || 
                               (typeof window.performance != "undefined" && 
                                window.performance.navigation.type === 2);

        if (historyTraversal) {
            window.location.reload();
        }
    });
</script>
{% endblock %}