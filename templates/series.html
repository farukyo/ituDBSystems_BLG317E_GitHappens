{% extends "base.html" %}

{% block title %}Series - BeeMD{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/series.css') }}">
{% endblock %}

{% block content %}
<div class="episodes-page">
    <div class="container">

        <h1>{{ title | default("All Series") }}</h1>
        <p class="sub-title">Browse and filter the complete TV series database</p>

        <!-- VIEW MODE SELECTOR -->
        <div class="view-selector" style="margin-bottom: 20px; display: flex; gap: 10px;">
            <a href="{{ url_for('series.series', q=request.args.get('q', ''), titleType=request.args.get('titleType', ''), startYear=request.args.get('startYear', ''), endYear=request.args.get('endYear', ''), isAdult=request.args.get('isAdult', '')) }}" 
               class="btn-view {% if not request.args.get('view') %}active{% endif %}">
                üì∫ Normal View
            </a>
            <a href="{{ url_for('series.series', q=request.args.get('q', ''), titleType=request.args.get('titleType', ''), startYear=request.args.get('startYear', ''), endYear=request.args.get('endYear', ''), isAdult=request.args.get('isAdult', ''), view='stats') }}" 
               class="btn-view {% if request.args.get('view') == 'stats' %}active{% endif %}">
                üìä Detailed Statistics
            </a>
        </div>

        <!-- SEARCH / FILTERS FORM -->
        <form action="{{ url_for('series.series') }}" method="GET" class="search-form">
            <div class="filter-grid">
                <!-- Search Box (spans full width on left) -->
                <div class="search-box">
                    <input type="text" name="q" placeholder="Search series..."
                           value="{{ request.args.get('q', '') }}">
                    <button type="submit">Search</button>
                </div>

                <!-- Type Filter -->
                <div class="filter-group">
                    <label>Type</label>
                    <select name="titleType">
                        <option value="">All Types</option>
                        <option value="tvSeries" {% if request.args.get('titleType') == 'tvSeries' %}selected{% endif %}>TV Series</option>
                        <option value="tvMiniSeries" {% if request.args.get('titleType') == 'tvMiniSeries' %}selected{% endif %}>Mini Series</option>
                    </select>
                </div>

                <!-- Start Year Filter -->
                <div class="filter-group">
                    <label>Start Year</label>
                    <select name="startYear">
                        <option value="">All Years</option>
                        <option value="2032" {% if request.args.get('startYear') == '2032' %}selected{% endif %}>2032</option>
                        <option value="2031" {% if request.args.get('startYear') == '2031' %}selected{% endif %}>2031</option>
                        <option value="2030" {% if request.args.get('startYear') == '2030' %}selected{% endif %}>2030</option>
                        <option value="2029" {% if request.args.get('startYear') == '2029' %}selected{% endif %}>2029</option>
                        <option value="2028" {% if request.args.get('startYear') == '2028' %}selected{% endif %}>2028</option>
                        <option value="2027" {% if request.args.get('startYear') == '2027' %}selected{% endif %}>2027</option>
                        <option value="2026" {% if request.args.get('startYear') == '2026' %}selected{% endif %}>2026</option>
                        <option value="2025" {% if request.args.get('startYear') == '2025' %}selected{% endif %}>2025</option>
                        <option value="2024" {% if request.args.get('startYear') == '2024' %}selected{% endif %}>2024</option>
                        <option value="2023" {% if request.args.get('startYear') == '2023' %}selected{% endif %}>2023</option>
                        <option value="2022" {% if request.args.get('startYear') == '2022' %}selected{% endif %}>2022</option>
                        <option value="2021" {% if request.args.get('startYear') == '2021' %}selected{% endif %}>2021</option>
                        <option value="2020" {% if request.args.get('startYear') == '2020' %}selected{% endif %}>2020</option>
                        <option value="2019" {% if request.args.get('startYear') == '2019' %}selected{% endif %}>2019</option>
                        <option value="2018" {% if request.args.get('startYear') == '2018' %}selected{% endif %}>2018</option>
                        <option value="2017" {% if request.args.get('startYear') == '2017' %}selected{% endif %}>2017</option>
                        <option value="2016" {% if request.args.get('startYear') == '2016' %}selected{% endif %}>2016</option>
                        <option value="2015" {% if request.args.get('startYear') == '2015' %}selected{% endif %}>2015</option>
                        <option value="2014" {% if request.args.get('startYear') == '2014' %}selected{% endif %}>2014</option>
                        <option value="2013" {% if request.args.get('startYear') == '2013' %}selected{% endif %}>2013</option>
                        <option value="2012" {% if request.args.get('startYear') == '2012' %}selected{% endif %}>2012</option>
                        <option value="2011" {% if request.args.get('startYear') == '2011' %}selected{% endif %}>2011</option>
                        <option value="2010" {% if request.args.get('startYear') == '2010' %}selected{% endif %}>2010</option>
                        <option value="2009" {% if request.args.get('startYear') == '2009' %}selected{% endif %}>2009</option>
                        <option value="2008" {% if request.args.get('startYear') == '2008' %}selected{% endif %}>2008</option>
                        <option value="2007" {% if request.args.get('startYear') == '2007' %}selected{% endif %}>2007</option>
                        <option value="2006" {% if request.args.get('startYear') == '2006' %}selected{% endif %}>2006</option>
                        <option value="2005" {% if request.args.get('startYear') == '2005' %}selected{% endif %}>2005</option>
                        <option value="2004" {% if request.args.get('startYear') == '2004' %}selected{% endif %}>2004</option>
                        <option value="2003" {% if request.args.get('startYear') == '2003' %}selected{% endif %}>2003</option>
                        <option value="2002" {% if request.args.get('startYear') == '2002' %}selected{% endif %}>2002</option>
                    </select>
                </div>

                <!-- End Year Filter -->
                <div class="filter-group">
                    <label>End Year</label>
                    <select name="endYear">
                        <option value="">All End Years</option>
                        <option value="2032" {% if request.args.get('endYear') == '2032' %}selected{% endif %}>2032</option>
                        <option value="2031" {% if request.args.get('endYear') == '2031' %}selected{% endif %}>2031</option>
                        <option value="2030" {% if request.args.get('endYear') == '2030' %}selected{% endif %}>2030</option>
                        <option value="2029" {% if request.args.get('endYear') == '2029' %}selected{% endif %}>2029</option>
                        <option value="2028" {% if request.args.get('endYear') == '2028' %}selected{% endif %}>2028</option>
                        <option value="2027" {% if request.args.get('endYear') == '2027' %}selected{% endif %}>2027</option>
                        <option value="2026" {% if request.args.get('endYear') == '2026' %}selected{% endif %}>2026</option>
                        <option value="2025" {% if request.args.get('endYear') == '2025' %}selected{% endif %}>2025</option>
                        <option value="2024" {% if request.args.get('endYear') == '2024' %}selected{% endif %}>2024</option>
                        <option value="2023" {% if request.args.get('endYear') == '2023' %}selected{% endif %}>2023</option>
                        <option value="2022" {% if request.args.get('endYear') == '2022' %}selected{% endif %}>2022</option>
                        <option value="2021" {% if request.args.get('endYear') == '2021' %}selected{% endif %}>2021</option>
                        <option value="2020" {% if request.args.get('endYear') == '2020' %}selected{% endif %}>2020</option>
                        <option value="2019" {% if request.args.get('endYear') == '2019' %}selected{% endif %}>2019</option>
                        <option value="2018" {% if request.args.get('endYear') == '2018' %}selected{% endif %}>2018</option>
                        <option value="2017" {% if request.args.get('endYear') == '2017' %}selected{% endif %}>2017</option>
                        <option value="2016" {% if request.args.get('endYear') == '2016' %}selected{% endif %}>2016</option>
                        <option value="2015" {% if request.args.get('endYear') == '2015' %}selected{% endif %}>2015</option>
                        <option value="2014" {% if request.args.get('endYear') == '2014' %}selected{% endif %}>2014</option>
                        <option value="2013" {% if request.args.get('endYear') == '2013' %}selected{% endif %}>2013</option>
                        <option value="2012" {% if request.args.get('endYear') == '2012' %}selected{% endif %}>2012</option>
                        <option value="2011" {% if request.args.get('endYear') == '2011' %}selected{% endif %}>2011</option>
                        <option value="2010" {% if request.args.get('endYear') == '2010' %}selected{% endif %}>2010</option>
                        <option value="2009" {% if request.args.get('endYear') == '2009' %}selected{% endif %}>2009</option>
                        <option value="2008" {% if request.args.get('endYear') == '2008' %}selected{% endif %}>2008</option>
                        <option value="2007" {% if request.args.get('endYear') == '2007' %}selected{% endif %}>2007</option>
                        <option value="2006" {% if request.args.get('endYear') == '2006' %}selected{% endif %}>2006</option>
                        <option value="2005" {% if request.args.get('endYear') == '2005' %}selected{% endif %}>2005</option>
                        <option value="2004" {% if request.args.get('endYear') == '2004' %}selected{% endif %}>2004</option>
                        <option value="2003" {% if request.args.get('endYear') == '2003' %}selected{% endif %}>2003</option>
                        <option value="2002" {% if request.args.get('endYear') == '2002' %}selected{% endif %}>2002</option>
                    </select>
                </div>

                <!-- Content Type Filter -->
                <div class="filter-group">
                    <label>Content</label>
                    <select name="isAdult">
                        <option value="">All Content</option>
                        <option value="0" {% if request.args.get('isAdult') == '0' %}selected{% endif %}>Not Adult</option>
                        <option value="1" {% if request.args.get('isAdult') == '1' %}selected{% endif %}>Adult (18+)</option>
                    </select>
                </div>

                <!-- Apply Button -->
                <div class="filter-buttons">
                    <button type="submit" id="filter-btn">Apply</button>
                </div>
            </div>
        </form>

        <hr>

        <!-- TABLE HEADER -->
        {% if items %}
            <div class="episode-table-header">
                <div>TITLE</div>
                <div>YEAR RANGE</div>
                <div>IMDB</div>
                <div>GENRE</div>
                <div>START YEAR</div>
                <div style="text-align: center;">LIKE</div>
            </div>
        {% endif %}

        <!-- SERIES LIST (Grid Layout) -->
        <div class="series-list">
            {% if items %}
                {% for row in items %}
                    <div class="series-item">
                        <!-- Title with 18+ badge -->
                        <div class="series-title">
                            <a href="{{ url_for('series.serie_detail', series_id=row.seriesId) }}" class="episode-title-link">
                                {{ row.seriesTitle }}
                            </a>
                            {% if row.isAdult == 1 %}
                                <span>18+</span>
                            {% endif %}
                        </div>

                        <!-- Year Range -->
                        <div class="col-year">
                            {{ row.startYear }} ‚Äì {{ row.endYear if row.endYear else '?' }}
                        </div>

                        <!-- IMDb Rating -->
                        <div class="col-rating">
                            {% if row.averageRating %}
                                {{ "%.1f"|format(row.averageRating) }}
                            {% else %}
                                -
                            {% endif %}
                        </div>

                        <!-- Genre -->
                        <div class="col-genre">
                            <div class="genre-tags">
                                {% for genre in (row.genre_str.split(', ') if row.genre_str else []) %}
                                    <span class="genre-tag">{{ genre }}</span>
                                {% endfor %}
                                {% if not row.genre_str %}
                                    <span class="genre-tag">Unknown</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Start Year -->
                        <div class="col-runtime">
                            {% if row.startYear %}
                                {{ row.startYear }}
                            {% else %}
                                -
                            {% endif %}
                        </div>
                        <div style="text-align: center;">
                            <button class="like-btn {{ 'liked' if row.is_liked else '' }}" 
                                    data-id="{{ row.seriesId }}" 
                                    data-type="series"
                                    onclick="toggleEntityLike(this, event)">
                                ‚ù§
                            </button>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-results">
                    <p>No series found.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
<script>
    function toggleEntityLike(btn, event) {
        event.preventDefault();
        event.stopPropagation();

        const entityId = btn.getAttribute('data-id');
        const entityType = btn.getAttribute('data-type'); 

        let formData = new FormData();
        formData.append('entity_id', entityId);
        formData.append('entity_type', entityType);

        fetch('/like_entity', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(data => {
            if (data === "1") {
                if (btn.classList.contains('liked')) {
                    btn.classList.remove('liked');
                } else {
                    btn.classList.add('liked');
                }
            } else {
                alert("Login required or error occurred.");
            }
        })
        .catch(err => console.error('Error:', err));
    }
</script>
{% endblock %}
