{% extends "base.html" %}

{% block title %}{{ title | default("Episodes") }} - BeeMD{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/episodes.css') }}">
{% endblock %}

{% block content %}
<div class="container episodes-page">

    <h1>TV Episodes</h1>

    <form action="{{ url_for('episode.episodes') }}" method="get" id="episode-filter-form">

        <!-- Filter Grid -->
        <div class="filter-grid">

            <!-- Episode Title -->
            <div class="filter-group">
                <label for="epTitle">Episode Title</label>
                <input type="text" id="epTitle" name="epTitle" placeholder="Search title..."
                    value="{{ request.args.get('epTitle') or '' }}">
            </div>

            <!-- Runtime Range -->
            <div class="filter-group">
                <label for="runtimeMin">Runtime (min)</label>
                <div class="range-inputs">
                    <input type="number" id="runtimeMin" name="runtimeMin" placeholder="Min" min="0"
                        value="{{ request.args.get('runtimeMin') or '' }}">
                    <span>-</span>
                    <input type="number" id="runtimeMax" name="runtimeMax" placeholder="Max" min="0"
                        value="{{ request.args.get('runtimeMax') or '' }}">
                </div>
            </div>

            <!-- Series Name -->
            <div class="filter-group">
                <label for="seriesName">Series Name</label>
                <input type="text" id="seriesName" name="seriesName" placeholder="Search series..."
                    value="{{ request.args.get('seriesName') or '' }}">
            </div>

            <!-- Season Number -->
            <div class="filter-group">
                <label for="seNumber">Season Number</label>
                <input type="number" id="seNumber" name="seNumber" placeholder="Season" min="1"
                    value="{{ request.args.get('seNumber') or '' }}">
            </div>

            <!-- Episode Number -->
            <div class="filter-group">
                <label for="epNumber">Episode Number</label>
                <input type="number" id="epNumber" name="epNumber" placeholder="Episode" min="1"
                    value="{{ request.args.get('epNumber') or '' }}">
            </div>

        </div>

        <!-- Buttons -->
        <div class="filter-buttons">
            <button type="submit" id="episode-filter-btn">Search</button>
            <a href="{{ url_for('episode.episodes') }}" class="btn-reset">Reset Filters</a>
        </div>

    </form>

    <hr>

    <div class="results-header">
        <h2 class="sub-title">Results ({{ items|length if items else 0 }} episodes)</h2>
        <button type="button" class="info-btn" id="showSqlBtn" title="Show SQL Query">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
        </button>
    </div>

    <!-- SQL Query Popup -->
    <div class="sql-popup-overlay" id="sqlPopup">
        <div class="sql-popup">
            <div class="sql-popup-header">
                <h3>Executed SQL Query</h3>
                <button type="button" class="close-btn" id="closeSqlBtn">&times;</button>
            </div>
            <div class="sql-popup-content">
                <pre><code>{{ sql_query | default('No query executed') }}</code></pre>
            </div>
        </div>
    </div>

    <div class="episode-list">
        {% if items %}

        <div class="episode-table-header">
            <span class="col-title">Title</span>
            <span class="col-runtime">Runtime</span>
            <span class="col-series">Series</span>
            <span class="col-season">Season</span>
            <span class="col-episode">Episode</span>
            <span style="text-align: center;">Like</span>
        </div>

        {% for episode in items %}
        <div class="episode-item">
            
            <span class="col-title">
                <a href="/episode/{{ episode.episodeId }}" class="episode-title-link">
                    {{ episode.epTitle or 'Untitled' }}
                </a>
            </span>
            
            <span class="col-runtime">
                {% if episode.runtimeMinutes %}
                {{ episode.runtimeMinutes }} min
                {% else %}
                N/A
                {% endif %}
            </span>
            
            <span class="col-series">
                {% if episode.seriesId %}
                <a href="/serie/{{ episode.seriesId }}" class="series-link">
                    {{ episode.seriesTitle or episode.seriesId }}
                </a>
                {% else %}
                N/A
                {% endif %}
            </span>
            
            <span class="col-season">
                {% if episode.seNumber %}
                S{{ episode.seNumber }}
                {% else %}
                -
                {% endif %}
            </span>
            
            <span class="col-episode">
                {% if episode.epNumber %}
                E{{ episode.epNumber }}
                {% else %}
                -
                {% endif %}
            </span>

            <span style="text-align: center;">
                <button class="like-btn {{ 'liked' if episode.is_liked else '' }}" 
                        data-id="{{ episode.episodeId }}" 
                        data-type="episode"
                        onclick="toggleEntityLike(this, event)">
                    ‚ù§
                </button>
            </span>

        </div> {% endfor %}
        
        {% else %}
        <div class="no-results">
            {% if request.args.get('epTitle') or request.args.get('seriesName') or
            request.args.get('seNumber') or request.args.get('epNumber') %}
            <p>No episodes found matching your criteria.</p>
            <p class="hint">Try adjusting your filters or use fewer search terms.</p>
            {% else %}
            <p>Use the filters above to search for episodes.</p>
            <p class="hint">You can filter by Title, Runtime, Series Name, Season, or Episode number.</p>
            {% endif %}
        </div>
        {% endif %}
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/episodes.js') }}"></script>
{% endblock %}